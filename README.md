# Домашнее задание к занятию "`Резервное копирование баз данных`" - `Доготер Егор`


### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

### Ответ 1. 

1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

* Для этого сценария оптимально подходит комбинация полного (Full) и дифференциального (Differential) резервного копирования. Раз в неделю делается полный бэкап (например, в ночь с воскресенья на понедельник холодное или горячая зависит от архитектуры и сервиса). Каждую следующую ночь делается дифференциальная копия, которая сохраняет все изменения, накопившиеся с момента последнего полного бэкапа.

2. Необходимо восстанавливать данные за час до предполагаемой поломки.

* Здесь требуется максимальная детализация. Подходит стратегия полного бэкапа + инкрементного (Incremental) бэкапа + резервное копирование журналов транзакций WAL или Binlog. Раз в неделю полный бэкап. Каждую ночь — инкрементный бэкап (только изменения за сутки). Плюс к этому непрерывно или с высокой частотой (например, каждые 5-10 минут в зависимости от нагрузки) архивируются журналы транзакций СУБД желательно с дублирование на сторонний сервер так как журналы транзакций часто оставляют на самом сервере нежеле бэкапы.

3. Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

* Да, при аппаратной ошибке при конфигурации master-master однако чаще используется master-slave где можно настроить автоматическое переключение что означает, что при отключении master один из серверов реплик получит статус master.

---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

### Ответ 2. 

1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

``` 
pg_dump --username=<role_name> --dbname=<source_db> --host=localhost --port=5432 --format=c > backup.dump
pg_restore --username=<role_name> --dbname=<target_db> --host=localhost --port=5432 --format=c < backup.dump
```
2. Возможно ли автоматизировать этот процесс? Если да, то как?

* Да, скрипты/команды работающие через cron или планироващик задач, также существуют утилиты которые берут на себя роль всего, а также могут выполнять дополнительные взаимодействия с backup к примеру pgBackRest
---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.* 

### Ответ 3. 

1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.

* Оффициальная документация предлагает раз в неделю делать полный бэкап включить **log_bin = ON** и написать скрпит для копирования бинарных файлов. Второй вариант MySQL Enterprise Backup который является платным 
```
mysqlbackup --incremental ---incremental-basedir=/full backup
```
Однако существует бесплатный аналог XtraBackup
```
xtrabackup --backup --target-dir=/inc --incremental-basedir=/full
```
2. В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

-
1. Можно снять backup с реплики без нагрузки на основной сервер
2. Нагрузку от аналитиков/data science специалистов пустить на реплику так как могут использовать сложные select запросы
3. Отказоусточивость как описывалось в 1 задании
4. Физическое распределение, в случае ошибки в одном дата-центре копия останется в другом при соответсвующей настройке
